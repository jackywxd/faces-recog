# Cursor Rules - ç…§ç‰‡äººè„¸è¯†åˆ«ç³»ç»Ÿ

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº Cloudflare å…¨æ ˆæŠ€æœ¯çš„ç°ä»£åŒ– Web äººè„¸è¯†åˆ«ç³»ç»Ÿï¼Œé‡‡ç”¨ Turborepo å•ä½“ä»“åº“æ¶æ„ï¼Œç»“åˆå®¹å™¨åŒ– AI æœåŠ¡ã€‚

## æ ¸å¿ƒå¼€å‘åŸåˆ™

### ğŸ¯ æµ‹è¯•é©±åŠ¨å¼€å‘ (TDD)
- **çº¢è‰²é˜¶æ®µ**: å…ˆå†™å¤±è´¥çš„æµ‹è¯•å®šä¹‰é¢„æœŸè¡Œä¸º
- **ç»¿è‰²é˜¶æ®µ**: ç¼–å†™æœ€å°‘ä»£ç ä½¿æµ‹è¯•é€šè¿‡  
- **é‡æ„é˜¶æ®µ**: æ”¹è¿›ä»£ç åŒæ—¶ä¿æŒæµ‹è¯•é€šè¿‡
- **éªŒæ”¶æ ‡å‡†**: æ¯ä¸ªè¿­ä»£å¿…é¡»é€šè¿‡ 100% Playwright è‡ªåŠ¨åŒ–æµ‹è¯•

### ğŸ”’ ç±»å‹å®‰å…¨ä¼˜å…ˆ
- ä½¿ç”¨ Zod æ¨¡å¼ä½œä¸ºç±»å‹å®šä¹‰å’ŒéªŒè¯çš„å•ä¸€çœŸå®æ¥æº
- ä» Zod æ¨¡å¼æ¨æ–­ TypeScript ç±»å‹: `type Photo = z.infer<typeof PhotoSchema>`
- é¿å…ä½¿ç”¨ `any` ç±»å‹ï¼Œä¼˜å…ˆä½¿ç”¨ `unknown`
- æ‰€æœ‰ API è¾“å…¥è¾“å‡ºéƒ½ç»è¿‡ Zod éªŒè¯

### ğŸ—ï¸ æ¶æ„æ¨¡å¼
- **å•ä½“ä»“åº“**: ä½¿ç”¨ Turborepo ç®¡ç†å¤šåŒ…ä¾èµ–
- **è¾¹ç¼˜ä¼˜å…ˆ**: åŸºäº Cloudflare å…¨æ ˆå¹³å°
- **å®¹å™¨åŒ– AI**: ä½¿ç”¨ Cloudflare Containers è¿è¡Œäººè„¸æ£€æµ‹æœåŠ¡
- **ä¼šè¯éš”ç¦»**: æ¯ä¸ªæœç´¢ä½œä¸šä½¿ç”¨ç‹¬ç«‹å®¹å™¨å®ä¾‹

---

## ğŸ“‹ æµ‹è¯•æŒ‡å— (Testing Guide)

### Playwright è‡ªåŠ¨åŒ–æµ‹è¯•

#### æµ‹è¯•ç»“æ„
```
tests/
â”œâ”€â”€ iteration-1/     # è¿­ä»£ 1: åŸºç¡€æ¶æ„æµ‹è¯• (5ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ iteration-2/     # è¿­ä»£ 2: é¢éƒ¨æ£€æµ‹æµ‹è¯• (6ä¸ªæµ‹è¯•ç”¨ä¾‹)  
â”œâ”€â”€ iteration-3/     # è¿­ä»£ 3: é¢éƒ¨åŒ¹é…æµ‹è¯• (7ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ iteration-4/     # è¿­ä»£ 4: æ€§èƒ½ä¼˜åŒ–æµ‹è¯• (8ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ iteration-5/     # è¿­ä»£ 5: ç”Ÿäº§å°±ç»ªæµ‹è¯• (8ä¸ªæµ‹è¯•ç”¨ä¾‹)
â”œâ”€â”€ api/            # API ç«¯ç‚¹æµ‹è¯•
â”œâ”€â”€ assets/         # æµ‹è¯•èµ„æºæ–‡ä»¶
â”œâ”€â”€ setup/          # å…¨å±€è®¾ç½®å’Œæ¸…ç†
â””â”€â”€ reporters/      # MCP è‡ªå®šä¹‰æŠ¥å‘Šå™¨
```

#### æµ‹è¯•è§„èŒƒ
- **æ•°æ®å±æ€§**: ä½¿ç”¨ `[data-testid="element-name"]` é€‰æ‹©å™¨
- **è¶…æ—¶è®¾ç½®**: é»˜è®¤ 30sï¼Œç½‘ç»œæ“ä½œ 15sï¼ŒUI äº¤äº’ 5s
- **é”™è¯¯å¤„ç†**: æ¯ä¸ªæµ‹è¯•éƒ½è¦éªŒè¯é”™è¯¯åœºæ™¯å’Œæ¢å¤æœºåˆ¶
- **æ¸…ç†ç­–ç•¥**: æµ‹è¯•åè‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ•°æ®å’Œæ–‡ä»¶

#### æµ‹è¯•å‘½ä»¤
```bash
pnpm test              # è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test:ui           # UI æ¨¡å¼è¿è¡Œæµ‹è¯•
pnpm test:debug        # è°ƒè¯•æ¨¡å¼
pnpm test:mcp          # MCP é›†æˆæµ‹è¯•
```

#### MCP é›†æˆ
- æµ‹è¯•ç»“æœè‡ªåŠ¨å‘é€åˆ° Cursor
- å®æ—¶è¿›åº¦æ›´æ–°å’Œé”™è¯¯æŠ¥å‘Š
- ç”Ÿæˆ Markdown æ ¼å¼çš„æµ‹è¯•æŠ¥å‘Š
- æ”¯æŒå¤šæµè§ˆå™¨å¹¶è¡Œæµ‹è¯• (Chrome, Firefox, Safari, Mobile)

### æµ‹è¯•ç”¨ä¾‹æ¨¡æ¿
```typescript
import { test, expect } from '@playwright/test';

test.describe('åŠŸèƒ½æ¨¡å—åç§°', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
    await page.waitForLoadState('networkidle');
  });

  test('å…·ä½“æµ‹è¯•åœºæ™¯æè¿°', async ({ page }) => {
    // å‡†å¤‡é˜¶æ®µ
    const element = page.locator('[data-testid="target-element"]');
    
    // æ‰§è¡Œé˜¶æ®µ
    await element.click();
    
    // éªŒè¯é˜¶æ®µ
    await expect(element).toHaveState('expected-state');
  });

  test.afterEach(async ({ page }) => {
    // æ¸…ç†èµ„æº
  });
});
```

---

## ğŸ¨ ç¼–ç æ ‡å‡† (Coding Standards)

### TypeScript è§„èŒƒ

#### ç±»å‹å®šä¹‰
```typescript
// âœ… å¥½çš„åšæ³•
import { z } from 'zod';

export const PhotoSchema = z.object({
  id: z.string().uuid(),
  filename: z.string().min(1).max(255),
  storagePath: z.string().min(1)
});

export type Photo = z.infer<typeof PhotoSchema>;

// âŒ é¿å…çš„åšæ³•
export interface Photo {
  id: any;  // ä¸è¦ä½¿ç”¨ any
  filename: string;
}
```

#### å‘½åçº¦å®š
- **ç±»å‹/æ¥å£/ç»„ä»¶**: PascalCase (`PhotoUpload`, `SearchResult`)
- **å˜é‡/å‡½æ•°/æ–¹æ³•**: camelCase (`uploadFile`, `detectFaces`)
- **å¸¸é‡**: SCREAMING_SNAKE_CASE (`MAX_FILE_SIZE`, `API_ENDPOINTS`)
- **æ–‡ä»¶å**: kebab-case (`photo-upload.tsx`, `face-detection.ts`)

### React ç»„ä»¶è§„èŒƒ

#### ç»„ä»¶ç»“æ„
```typescript
// âœ… æ ‡å‡†ç»„ä»¶æ¨¡æ¿
import React, { useCallback, useState } from 'react';
import { Card, Button, Progress } from '@/components/ui';
import { PhotoUploadProps } from '@/types';

const PhotoUpload: React.FC<PhotoUploadProps> = ({ onUpload }) => {
  // 1. Hooks åœ¨é¡¶éƒ¨
  const [file, setFile] = useState<File | null>(null);
  
  // 2. äº‹ä»¶å¤„ç†å‡½æ•°
  const handleFileSelect = useCallback((file: File) => {
    // å®ç°é€»è¾‘
  }, []);
  
  // 3. æ¸²æŸ“
  return (
    <Card data-testid="upload-area">
      {/* JSX å†…å®¹ */}
    </Card>
  );
};

export default PhotoUpload;
```

#### shadcn/ui ä½¿ç”¨è§„èŒƒ
- ä¼˜å…ˆä½¿ç”¨ shadcn/ui ç»„ä»¶è€Œä¸æ˜¯è‡ªå®šä¹‰ç»„ä»¶
- ä¿æŒç»„ä»¶çš„å¯è®¿é—®æ€§å±æ€§
- ä½¿ç”¨ Tailwind CSS è¿›è¡Œæ ·å¼å®šåˆ¶
- éµå¾ªè®¾è®¡ç³»ç»Ÿçš„é¢œè‰²å’Œé—´è·è§„èŒƒ

### API å¼€å‘è§„èŒƒ

#### Hono è·¯ç”±ç»“æ„
```typescript
// âœ… æ ‡å‡†è·¯ç”±å®ç°
import { Hono } from 'hono';
import { z } from 'zod';

const app = new Hono<{
  Bindings: {
    DB: D1Database;
    BUCKET: R2Bucket;
    FACE_DETECTOR: DurableObjectNamespace;
  };
}>();

app.post('/api/upload', async (c) => {
  // 1. è¾“å…¥éªŒè¯
  const result = UploadRequestSchema.safeParse(await c.req.json());
  if (!result.success) {
    return c.json({ error: result.error }, 400);
  }
  
  // 2. ä¸šåŠ¡é€»è¾‘
  // 3. è¿”å›å“åº”
});
```

#### é”™è¯¯å¤„ç†è§„èŒƒ
```typescript
// âœ… ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
interface ErrorResponse {
  error: true;
  code: string;
  message: string;
  details?: unknown;
}
```

### å®¹å™¨åŒ–æœåŠ¡è§„èŒƒ

#### é¢éƒ¨æ£€æµ‹æœåŠ¡
```typescript
// âœ… å®¹å™¨æœåŠ¡æ ‡å‡†ç»“æ„
export class FaceDetectorContainer extends Container {
  defaultPort = 8080;
  sleepAfter = '10m';
  enableInternet = false;
  
  override async onStart() {
    // å®¹å™¨å¯åŠ¨é€»è¾‘
  }
  
  override async onStop() {
    // ä¼˜é›…å…³é—­é€»è¾‘
  }
  
  override async onError(error: Error) {
    // é”™è¯¯å¤„ç†é€»è¾‘
  }
}
```

---

## ğŸ“¦ å…±äº«åŒ…æŒ‡å— (Shared Package Guide)

### åŒ…ç»“æ„
```
packages/shared/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/           # Zod æ¨¡å¼å’Œ TypeScript ç±»å‹
â”‚   â”œâ”€â”€ constants/       # åº”ç”¨ç¨‹åºå¸¸é‡
â”‚   â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ services/       # æœåŠ¡æŠ½è±¡
â”‚   â”œâ”€â”€ stores/         # Zustand çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ test/           # æµ‹è¯•å·¥å…·å’Œå¤¹å…·
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

### æœåŠ¡æŠ½è±¡å±‚

#### å­˜å‚¨æœåŠ¡
```typescript
// âœ… å­˜å‚¨æŠ½è±¡æ¥å£
export interface StorageAdapter {
  upload(file: Buffer, key: string): Promise<string>;
  download(key: string): Promise<Buffer>;
  delete(key: string): Promise<void>;
  getUrl(key: string): Promise<string>;
}

// ç¯å¢ƒé€‚é…
export function createStorageAdapter(): StorageAdapter {
  return process.env.NODE_ENV === 'production' 
    ? new R2StorageAdapter()
    : new LocalStorageAdapter();
}
```

#### æ•°æ®åº“æœåŠ¡
```typescript
// âœ… æ•°æ®åº“æŠ½è±¡æ¥å£
export interface DatabaseAdapter {
  photos: PhotoRepository;
  faceEncodings: FaceEncodingRepository;
  searchJobs: SearchJobRepository;
}

export function createDatabaseAdapter(): DatabaseAdapter {
  return process.env.NODE_ENV === 'production'
    ? new D1DatabaseAdapter()
    : new SQLiteDatabaseAdapter();
}
```

### çŠ¶æ€ç®¡ç†

#### Zustand å­˜å‚¨æ¨¡å¼
```typescript
// âœ… çŠ¶æ€ç®¡ç†æ¨¡æ¿
import { create } from 'zustand';

interface UploadState {
  files: File[];
  progress: Record<string, number>;
  errors: Record<string, string>;
  
  // Actions
  addFile: (file: File) => void;
  updateProgress: (fileId: string, progress: number) => void;
  setError: (fileId: string, error: string) => void;
}

export const useUploadStore = create<UploadState>((set, get) => ({
  files: [],
  progress: {},
  errors: {},
  
  addFile: (file) => set((state) => ({
    files: [...state.files, file]
  })),
  
  updateProgress: (fileId, progress) => set((state) => ({
    progress: { ...state.progress, [fileId]: progress }
  })),
  
  setError: (fileId, error) => set((state) => ({
    errors: { ...state.errors, [fileId]: error }
  }))
}));
```

### å·¥å…·å‡½æ•°è§„èŒƒ

#### éªŒè¯å·¥å…·
```typescript
// âœ… è¾“å…¥éªŒè¯æ¨¡æ¿
export function validateImageFile(file: File): ValidationResult {
  const result = FileUploadSchema.safeParse(file);
  return {
    isValid: result.success,
    errors: result.success ? [] : result.error.issues
  };
}
```

#### å›¾åƒå¤„ç†å·¥å…·
```typescript
// âœ… å›¾åƒå¤„ç†æ¨¡æ¿
import sharp from 'sharp';

export async function createThumbnail(
  buffer: Buffer, 
  width: number = 300
): Promise<Buffer> {
  return sharp(buffer)
    .resize(width, width, { 
      fit: 'cover',
      position: 'center'
    })
    .jpeg({ quality: 80 })
    .toBuffer();
}
```

---

## ğŸš€ éƒ¨ç½²æŒ‡å— (Deployment Guide)

### Cloudflare éƒ¨ç½²æ¶æ„

#### Turborepo æ„å»ºæµç¨‹
```bash
# å¢é‡æ„å»º
pnpm run build

# ç±»å‹æ£€æŸ¥
pnpm run type-check

# æµ‹è¯•éªŒè¯
pnpm run test

# éƒ¨ç½²
pnpm run deploy
```

#### å‰ç«¯éƒ¨ç½² (Cloudflare Pages)
```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export',
  trailingSlash: true,
  images: {
    unoptimized: true
  }
};

module.exports = nextConfig;
```

#### API éƒ¨ç½² (Cloudflare Workers)
```jsonc
// wrangler.jsonc
{
  "name": "face-recognition-api",
  "main": "src/index.ts",
  "compatibility_date": "2024-12-01",
  "compatibility_flags": ["nodejs_compat"],
  
  "containers": [
    {
      "class_name": "FaceDetectorContainer",
      "image": "../face-detector/Dockerfile",
      "instances": 5,
      "name": "face-detector-service"
    }
  ],
  
  "durable_objects": {
    "bindings": [
      {
        "name": "FACE_DETECTOR",
        "class_name": "FaceDetectorContainer"
      }
    ]
  },
  
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "face-recognition-db"
    }
  ],
  
  "r2_buckets": [
    {
      "binding": "BUCKET",
      "bucket_name": "face-recognition-photos"
    }
  ]
}
```

#### å®¹å™¨éƒ¨ç½²é…ç½®
```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    cairo-dev \
    jpeg-dev \
    pango-dev \
    musl-dev

# å®‰è£…å’Œæ„å»º
COPY package*.json ./
RUN npm ci --only=production

COPY src/ ./src/
COPY models/ ./models/
RUN npm run build

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# å¯åŠ¨æœåŠ¡
CMD ["node", "dist/server.js"]
```

### CI/CD æµç¨‹

#### GitHub Actions é…ç½®
```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm run build
      - run: pnpm run test
      - run: pnpm run lint
      - run: pnpm run type-check
      
      - name: Playwright Tests
        run: pnpm run test:e2e

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Cloudflare
        run: |
          pnpm run deploy:web
          pnpm run deploy:api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
```

### ç¯å¢ƒç®¡ç†

#### ç¯å¢ƒå˜é‡é…ç½®
```typescript
// ç¯å¢ƒå˜é‡ç±»å‹å®šä¹‰
declare global {
  namespace NodeJS {
    interface ProcessEnv {
      NODE_ENV: 'development' | 'production' | 'test';
      TEST_BASE_URL?: string;
      API_BASE_URL?: string;
      CLOUDFLARE_API_TOKEN?: string;
      CLOUDFLARE_ACCOUNT_ID?: string;
    }
  }
}
```

#### æ•°æ®åº“è¿ç§»
```bash
# åˆ›å»º D1 æ•°æ®åº“
npx wrangler d1 create face-recognition-db

# æ‰§è¡Œè¿ç§»
npx wrangler d1 migrations apply face-recognition-db

# æŸ¥è¯¢æ•°æ®åº“
npx wrangler d1 execute face-recognition-db --command="SELECT * FROM photos LIMIT 5"
```

---

## ğŸ” å¼€å‘å·¥ä½œæµ

### æ–°åŠŸèƒ½å¼€å‘
1. **åˆ›å»ºåˆ†æ”¯**: `git checkout -b feature/æ–°åŠŸèƒ½å`
2. **ç¼–å†™æµ‹è¯•**: å…ˆå†™å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹
3. **å®ç°åŠŸèƒ½**: ç¼–å†™æœ€å°‘ä»£ç ä½¿æµ‹è¯•é€šè¿‡
4. **é‡æ„ä¼˜åŒ–**: æ”¹è¿›ä»£ç ç»“æ„å’Œæ€§èƒ½
5. **æäº¤ä»£ç **: ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
6. **åˆ›å»º PR**: ä»£ç å®¡æŸ¥å’Œè‡ªåŠ¨åŒ–æµ‹è¯•

### è¿­ä»£å¼€å‘æµç¨‹
æŒ‰ç…§ä»»åŠ¡æ¸…å•ä¸­çš„ 5 ä¸ªè¿­ä»£è¿›è¡Œï¼š
- **è¿­ä»£ 1**: åŸºç¡€æ¶æ„åŸå‹ (16ä¸ªä»»åŠ¡ï¼Œ5ä¸ªæµ‹è¯•ç”¨ä¾‹)
- **è¿­ä»£ 2**: é¢éƒ¨æ£€æµ‹åŸå‹ (11ä¸ªä»»åŠ¡ï¼Œ6ä¸ªæµ‹è¯•ç”¨ä¾‹)  
- **è¿­ä»£ 3**: é¢éƒ¨åŒ¹é…åŸå‹ (13ä¸ªä»»åŠ¡ï¼Œ7ä¸ªæµ‹è¯•ç”¨ä¾‹)
- **è¿­ä»£ 4**: æ€§èƒ½å’Œä½“éªŒä¼˜åŒ– (15ä¸ªä»»åŠ¡ï¼Œ8ä¸ªæµ‹è¯•ç”¨ä¾‹)
- **è¿­ä»£ 5**: ç”Ÿäº§å°±ç»ª (17ä¸ªä»»åŠ¡ï¼Œ8ä¸ªæµ‹è¯•ç”¨ä¾‹)

### ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•
- [ ] ç±»å‹å®‰å…¨ï¼šä½¿ç”¨ Zod éªŒè¯å’Œ TypeScript ç±»å‹
- [ ] æµ‹è¯•è¦†ç›–ï¼šåŒ…å«å•å…ƒæµ‹è¯•å’Œ E2E æµ‹è¯•
- [ ] é”™è¯¯å¤„ç†ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼šç¬¦åˆæ€§èƒ½æŒ‡æ ‡è¦æ±‚
- [ ] å®‰å…¨è€ƒè™‘ï¼šè¾“å…¥éªŒè¯å’Œè®¿é—®æ§åˆ¶
- [ ] æ–‡æ¡£æ›´æ–°ï¼šAPI æ–‡æ¡£å’Œä»£ç æ³¨é‡Š

---

## ğŸ“– å‚è€ƒèµ„æº

- **é¡¹ç›®æ¦‚è¿°**: `project-overview.md`
- **è®¾è®¡æ–‡æ¡£**: `design-document.md` 
- **ä»»åŠ¡æ¸…å•**: `tasks.md`
- **éœ€æ±‚æ–‡æ¡£**: `requirements.md`

---

*æœ¬é¡¹ç›®ä»£è¡¨äº†ç°ä»£åŒ– Web å¼€å‘çš„æœ€ä½³å®è·µï¼Œç»“åˆäº† Turborepo çš„æ„å»ºä¼˜åŒ–ã€Cloudflare çš„è¾¹ç¼˜è®¡ç®—ã€å®¹å™¨åŒ–çš„ AI æœåŠ¡ï¼Œä»¥åŠä¸¥æ ¼çš„æµ‹è¯•é©±åŠ¨å¼€å‘æ–¹æ³•ã€‚* 